# COUNTLAND benchmark - Pig and placozoan data
### Samuel H. Church

This document applies `countland` to the analysis of real-world scRNA-seq data.

The following packages are required to run the analysis:

```{r load,results=F,message=F}
library(knitr)
library(dplyr)
library(Seurat)
library(aricode)
library(clevr)

library(ggplot2)
library(viridis)
library(gridExtra)
theme_set(theme_classic())
```

```{r source,results=F}
source("R/countland.R")
source("R/countland_cluster.R")
source("R/countland_rank_reduction.R")
source("R/countland_genes.R")
source("R/countland_utils.R")
```

## GET THE DATA

Here we apply countland to a dataset from the placozoan (_Trichoplax adherens_) provided by [Seb√©-Pedros _et al_ (2018)](https://doi.org/10.1038/s41559-018-0575-6), and a dataset from the pig (_Sus scrofa_) provided by [van Zyl _et al_ (2020](https://www.pnas.org/cgi/doi/10.1073/pnas.2001250117).

```{r data}
Tri.data <- Seurat::Read10X(data.dir = "../data/Trichoplax_SebePedros2018")
Sus.data <- Seurat::Read10X(data.dir = "../data/Pig9_vanZyl2020_mtx")
```

## RUN COUNTLAND

We first apply spectral embeddding to the two datasets.

```{r run,results=F}
Sus <- countland(Sus.data,remove_empty = TRUE)
Sus <- Subsample(Sus,n_counts=min(apply(Sus@counts,2,sum)))
Sus <- Dot(Sus,subsample=T)
Sus <- Embed(Sus,n_components=20)

Tri <- countland(Tri.data,remove_empty = TRUE)
Tri <- Subsample(Tri,n_counts=min(apply(Tri@counts,2,sum)))
Tri <- Dot(Tri,subsample=T)
Tri <- Embed(Tri,n_components=20)
```
Because we have no _a priori_ hypothesis as to the number of clusters that may be present, we check to see if the eigengap heuristic for spectral clustering is informative.

For _S. scrofa_, it appears as though the largest visible gap at the highest value is between 7 and 8, so we will use 7 clusters.

```{r elbow-Sus}
PlotEigengap(Sus)
```
For _T. adherens_, it appears that the largest visible gap is between 11 and 12, so we will use 11 clusters.

```{r elbow-Tri}
PlotEigengap(Tri)
```

```{r cluster}
Sus <- Cluster(Sus,n_clusters=7,n_components=7)
Tri <- Cluster(Tri,n_clusters=11,n_components=11)
```

We can visualize the results using spectral embedding.

```{r plot-Tri,fig.height=4,fig.width=6,fig.align="center"}
embed <- Tri@embedding[,2:3]
embed <- setNames(data.frame(embed),paste("component_",seq_len(2),sep=""))

ggplot2::ggplot(embed,aes(x = component_1,y = component_2, color=as.character(Tri@cluster_labels))) +
geom_point(size=1) +
guides(color=guide_legend(title="cluster")) +
scale_color_manual(values=c(color_palette,"black"))
```

In the case of _S. scrofa_ we see that the first two variable components from sepctral embedding are not very informative, so it is helpful to view additional components.

```{r plot-Sus,fig.height=4,fig.width=6,fig.align="center"}
Scl <- paste0("countland_cluster:",as.character(Sus@cluster_labels))
Scolor <- viridis::turbo(n=8)
Sdf <- setNames(data.frame(Sus@embedding[,2:5]),paste0("component_",seq_len(4)))
Sdf$clusters <- Scl
g1 <- ggplot(Sdf,aes(x = component_1, y = component_2, color = clusters)) + 
  geom_point(size=1) + 
  scale_color_manual(values=Scolor) +
  theme("legend.position" = "none") + 
  theme(axis.ticks = element_blank(),axis.text = element_blank())
g2 <- ggplot(Sdf,aes(x = component_3, y = component_4, color = clusters)) + 
  geom_point(size=1) + 
  scale_color_manual(values=Scolor) +
  theme("legend.position" = "none") + 
  theme(axis.ticks = element_blank(),axis.text = element_blank())
grid.arrange(g1,g2,ncol=2)
```

