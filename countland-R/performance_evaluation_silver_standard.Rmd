# COUNTLAND benchmark - Silver Standard Dataset
### Samuel H. Church

This document applies `countland` to the analysis of a benchmark scRNA-seq dataset to test its performance.

The following packages are required to run the analysis:

```{r load,results=F,message=F}
library(knitr)
library(dplyr)
library(Seurat)
library(aricode)
library(clevr)

library(ggplot2)
library(viridis)
library(gridExtra)
theme_set(theme_classic())
```

```{r source,results=F}
source("R/countland.R")
source("R/countland_cluster.R")
source("R/countland_rank_reduction.R")
source("R/countland_genes.R")
source("R/countland_utils.R")
```

## GET THE DATA

We have used the Silver standard dataset( (3A) provided by [Freytag _et al_ (2018)](10.12688/f1000research.15809.2). This data consists of ~33,000 cells that have reported labels corresponding to human blood cell lines.

```{r data}
silver.data <- Seurat::Read10X(data.dir = "../data/Silver_Freytag2018/SilverDataset3a_Freytag2018")
```

## RUN COUNTLAND

The following code tests the countland approach for identifying cluster of cells. Here we vary the number of clusters (5, 8, and 11) and the  the number of components (5, 8, and 11) used in spectral clustering.

```{r run-countland}
run_countland <- function(data,n_clusters,n_components){
  C <- countland(data,remove_empty = TRUE)
  C <- Dot(C)
  C <- Embed(C)
  C <- Cluster(C,n_clusters=n_clusters,n_components=n_components)
  return(C)
}
```

```{r run,results=F,cache=T}
C_silver_5_5 <- run_countland(silver.data,5,5)
C_silver_5_8 <- run_countland(silver.data,5,8)
C_silver_5_11 <- run_countland(silver.data,5,11)

C_silver_8_5 <- run_countland(silver.data,8,5)
C_silver_8_8 <- run_countland(silver.data,8,8)
C_silver_8_11 <- run_countland(silver.data,8,11)

C_silver_11_5 <- run_countland(silver.data,11,5)
C_silver_11_8 <- run_countland(silver.data,11,8)
C_silver_11_11 <- run_countland(silver.data,11,11)
```

We use three measures for evaluating clustering: the adjusted rand index, the normalized mutual information, and cluster homogeneity.

```{r ARI}
C_results <- c(C_silver_5_5,C_silver_5_8,C_silver_5_11,C_silver_8_5,C_silver_8_8,C_silver_8_11,C_silver_11_5,C_silver_11_8,C_silver_11_11)

rand <- sapply(C_results,function(x){ARI(gsub("_.*","",x@names_cells),x@cluster_labels)})
nmi <- sapply(C_results,function(x){NMI(gsub("_.*","",x@names_cells),x@cluster_labels)})
homog <- sapply(C_results,function(x){homogeneity(gsub("_.*","",x@names_cells),x@cluster_labels)})
n_clusters <- c("5 clusters", "8 clusters", "11 clusters")
n_components <- c("5 components","8 components","11 components")

ari_results <- setNames(data.frame(round(matrix(rand,ncol=3),3)),n_clusters)
rownames(ari_results) <- n_components
kable(t(ari_results),caption="cluster evaluation: adjusted rand index")

nmi_results <- setNames(data.frame(round(matrix(nmi,ncol=3),3)),n_clusters)
rownames(nmi_results) <- n_components
kable(t(nmi_results),caption="cluster evaluation: norm. mutual info.")

homog_results <- setNames(data.frame(round(matrix(homog,ncol=3),3)),n_clusters)
rownames(homog_results) <- n_components
kable(t(homog_results),caption="cluster evaluation: cluster homogeneity")
```

```{r plot,fig.height=12,fig.width=12,fig.align="center"}
C <- C_silver_5_8
gdf <- data.frame("component1" = C@embedding[,2], "component2" = C@embedding[,3],  "label" = gsub("_.*","",C@names_cells))
p_cell_label <- ggplot(gdf,aes(x = component1, y = component2, color = label)) + geom_point(size=1) + scale_color_manual(values=viridis::plasma(n=length(unique(gdf$label)))) + theme(legend.position="none") + ggtitle("cell labels")

gdf <- data.frame("component1" = C@embedding[,2], "component2" = C@embedding[,3],  "cluster" = as.character(C@cluster_labels))
p_C_silver_5_8 <- ggplot(gdf,aes(x = component1, y = component2, color = cluster)) + geom_point(size=1) + scale_color_manual(values=viridis::viridis(n=length(unique(C@cluster_labels)))) + theme(legend.position="none") + ggtitle("5 clusters, 8 components")

C <- C_silver_8_8
gdf <- data.frame("component1" = C@embedding[,2], "component2" = C@embedding[,3],  "cluster" = as.character(C@cluster_labels))
p_C_silver_8_8 <- ggplot(gdf,aes(x = component1, y = component2, color = cluster)) + geom_point(size=1) + scale_color_manual(values=viridis::viridis(n=length(unique(C@cluster_labels)))) + theme(legend.position="none") + ggtitle("8 clusters, 8 components")


C <- C_silver_11_8
gdf <- data.frame("component1" = C@embedding[,2], "component2" = C@embedding[,3],  "cluster" = as.character(C@cluster_labels))
p_C_silver_11_8 <- ggplot(gdf,aes(x = component1, y = component2, color = cluster)) + geom_point(size=1) + scale_color_manual(values=viridis::viridis(n=length(unique(C@cluster_labels)))) + theme(legend.position="none") + ggtitle("11 clusters, 8 components")

gdf <- data.frame("component1" = C@embedding[,2], "component2" = C@embedding[,3],  "cluster" = as.character(gsub("_.*","",C@names_cells)))
p_real_spectral <- ggplot(gdf,aes(x = component1, y = component2, color = cluster)) + geom_point(size=1) + scale_color_brewer(palette="Paired") + theme(legend.position="none")

gridExtra::grid.arrange(p_cell_label,
                        p_C_silver_5_8,
                        p_C_silver_8_8,
                        p_C_silver_11_8,
                        ncol=2)
```
